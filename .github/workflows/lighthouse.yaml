name: Lighthouse CI
on:
  pull_request:
jobs:
  lhci:
    # if: github.event.deployment_status.state == 'success'
    name: Lighthouse CI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Node
        uses: actions/setup-node@v2.1.5
        with:
          node-version: 14

      - name: Cache pnpm modules
        uses: actions/cache@v2
        env:
          cache-name: cache-pnpm-modules
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ matrix.node-version }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-${{ matrix.node-version }}-

      - uses: pnpm/action-setup@v2.0.1
        with:
          version: latest
          run_install: true

      - name: Build
        run: pnpm nx build app --prod

      - name: Git branch name
        id: git-branch-name
        uses: EthanSK/git-branch-name-action@v1
      - name: TODO Retrieve deployment URL (example on how to set an ENV var)
        run: "echo VERCEL_DEPLOYMENT_URL=perfolio-${{ env.GIT_BRANCH_NAME }}-chronark.vercel-app >> $GITHUB_ENV"

      - uses: UnlyEd/github-action-await-vercel@v1.1.0
        id: await-vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        with:
          deployment-url: ${{ env.VERCEL_DEPLOYMENT_URL}}
          timeout: 600

      - name: run Lighthouse CI
        run: |
          for RAW_PATH in $(find ./dist/apps/app/.next/server/pages -type f -name "*.html")
          do
              cleaned_path=${RAW_PATH#"./dist/apps/app/.next/server/pages"}
              cleaned_path=${cleaned_path%".html"}
              echo $cleaned_path

              pnpm lhci autorun --collect.url=${DEPLOY_URL}${cleaned_path}
          done

        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          # DEPLOY_URL: ${{ github.event.deployment_status.target_url }}
          DEPLOY_URL: ${{ fromJson(steps.await-vercel.outputs.deploymentDetails).url }}
